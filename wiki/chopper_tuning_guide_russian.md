### Метод полу-автоматической калибровки параметров драйвера основан на [мануале](https://www.analog.com/en/app-notes/AN-001.html) Trinamic по "поведенческой" настройке мотора.


### 1. Установка скрипта калибровки на хост принтера. (последует перезагрузка клиппера!)
```
cd ~
git clone https://github.com/MRX8024/chopper-resonance-tuner
bash ~/chopper-resonance-tuner/install.sh
```
   Если все прошло успешно, вы увидете у себя в домашней директории (конфигурации принтера) появившиеся папки с программой, и в которую после будут помещаться результаты калибровок, а так же уже доступный макрос из панели макросов на главной странице "вебморды".
   А если по каким то причинам нет, то установите [вручную](/wiki/manual_install_ru.md).

2. Подключаем акселерометр к головке, как например при измерении резонансов для input_shaper.

3. Калибровка:

   1. Определяем «резонирующие» скорости, введя в терминал вебморды команду `CHOPPER_TUNE FIND_VIBRATIONS=1` (дальнейшие команды в этой статье будут трактоваться с минимально необходимыми параметрами(функциями)), дополнительно можно еще задать скорость параметрами `MIN_SPEED=20 MAX_SPEED=100`, голова принтера совершит прогоны на заданных скоростях с шагом 1мм/с.
   2. После завершения работы макроса алгоритм автоматически сгенерирует таблица данных и графики, поместит их в директорию `.../adxl_results/chopper_magnitude/`, скачиваем и открываем `interactive_plot.html` и видим следующую картину -
   ![](/wiki/pictures/img_1.png)
   На графике будет видно обычно 2 пика, на скорости около 50мм/с и 100мм/с - это резонансные скорости, нам нужна наименьшая из этих скоростей, например - 55мм/с.
   3. Запускаем макрос для перебора всех вариантов чоппера на выбранной ранее скорости, команда будет выглядеть вот так 
   -`CHOPPER_TUNE TBL_MIN=0 TBL_MAX=3 TOFF_MIN=1 TOFF_MAX=8 MIN_HSTRT=0 MAX_HSTRT=7 MIN_HEND=2 MAX_HEND=15 MIN_SPEED=55 MAX_SPEED=55`. Проверьте наличие свободного места на хосте, под данные необходимо ~пол гб.
   Время сбора данных займет примерно час-два, после завершения точно так же открываем график, как и в предыдущий раз, получаем график вида -
   ![](/wiki/pictures/img_2.png)
   В этом примере минимальные вибрации при TBL=0 и TOFF=8. Увеличиваем эту область.
   ![](/wiki/pictures/img_3.png)
   4. Выбираем вариант чоппера с минимальным значением магнитуды - это искомые параметры. Так же нужно учитывать, что при больших значениях `TBL` и `TOFF` снижается частота мотора, что ведет к появлению противного шума, найдите грань. 
   Вписываем их в секцию драйверов в printer.cfg, пример -
   ```
   [tmc5160 stepper_x]
   cs_pin: PC4
   ...
   driver_TBL: 0
   driver_TOFF: 8
   driver_HSTRT: 5
   driver_HEND: 5
   ```

   5. Можно повторить процедуру с меньшими вариациями чоппера, например, только `TBL=0` и `TOFF=8` и перебрать полные диапазоны `HSTRT` и `HEND`, но с большим количеством повторений `ITERATIONS`. В этом случае график будет построен по средним результатам, чтобы уменьшить влияние механики на показания.

4. Описание функционала программы -
   1. `CURRENT_MIN_MA` и `CURRENT_MAX_MA` - отвечают за изменения подающегося тока `(мА)` на шаговые двигатели с шагом 10мА, допустим, если вам хватает момента, который выдают шаговые двигатели, вы можете снизить их ток дабы сделать систему тише, эта функция и позволяет проанализировать, стоит ли игра свеч.
   2. `TBL_MIN-0` и `TBL_MAX-3`, `TOFF_MIN-1` и `TOFF_MAX-8`, `MIN_HSTRT-0` и `MAX_HSTRT-7`, `MIN_HEND-0` и `MAX_HEND-15` - собственно так же отвечают за перебор параметров, в данном случае - регистров пар драйверов. Указаны их диапазоны работ, и по совокупности перебора, а `HSTRT_HEND_MAX-15` - константа. ([подробнее](https://www.analog.com/en/app-notes/AN-001.html))
   3. `MIN_SPEED` и `MAX_SPEED` - перебор диапазона скоростей, с шагом `1мм/c`.
   4. `ITERATIONS` - количество повторений замеров, для более точных данных.
   5. `TRAVEL_DISTANCE` - дистанция `(мм)` движения печатающей головки во время которого происходит считывание вибраций. По умолчанию авто рассчитывается исходя из способностей принтера.
   6. `ACCELEROMETER` - акселерометр, который будет использован для измерения вибраций, авто определится, если таковой указан в конфигурации `resonance_tester`, в противном случае будет применен adxl345.
   7. `FIND_VIBRATIONS` - режим измерения вибраций от скорости, полезно дабы вычеркнуть из повседневной печати резонансные скорости, как и для 3.1 шага данной статьи. Значения - `(True / False), (1 / 0)`

Параметры `'default'` означают, что при отсутствии аргумента эта переменная присвоит дефолтные(базовые) параметры из printer.cfg, либо посчитает минимально требуемые.
